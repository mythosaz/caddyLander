<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin</title>
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <style>
    :root {
      --bg: #111;
      --text: #eee;
      --panel: #333;
      --border: #444;
      --button: #444;
      --button-hover: #555;
      --button-active: #0b63c5;
      --muted: #aaa;
      --status: #333;
      --link-color: #8ab4f8;
      --link-hover-color: #c6e0ff;
      --input-bg: #333;
      --input-border: #666;
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --text: #111;
      --panel: #ffffff;
      --border: #ccc;
      --button: #e5e7eb;
      --button-hover: #d1d5db;
      --button-active: #2563eb;
      --muted: #555;
      --status: #f3f4f6;
      --link-color: #0b63c5;
      --link-hover-color: #094a96;
      --input-bg: #fff;
      --input-border: #cbd5e1;
    }

    body {
      font-family: system-ui;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
      margin: 0;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    a {
      color: var(--link-color);
      text-decoration: none;
      font-weight: 600;
    }

    a:hover,
    a:focus {
      color: var(--link-hover-color);
      text-decoration: underline;
    }

    button {
      padding: 0.5rem 1.2rem;
      margin: 0.25rem;
      background: var(--button);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    button:hover {
      background: var(--button-hover);
    }

    button.active {
      background: var(--button-active);
      border-color: var(--button-active);
      color: #fff;
    }

    select,
    input[type="file"] {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }

    .panel {
      margin-bottom: 2rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }

    .status {
      margin-top: 0.5rem;
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 4px;
      background: var(--status);
    }

    .note {
      background: var(--status);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .file-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .file-tabs button {
      flex: 1;
    }

    .editor-container {
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 1rem;
      background: #282c34;
    }

    .editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .cm-editor {
      height: 500px;
      font-size: 14px;
    }

    details {
      margin: 1rem 0;
      padding: 0.75rem;
      background: var(--panel);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    summary {
      cursor: pointer;
      font-weight: bold;
    }

    details div {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    code {
      background: var(--status);
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
    }

    .build-number {
      color: var(--muted);
      font-size: 0.7rem;
      margin-left: 0.5rem;
      font-weight: normal;
    }

    .view-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .view-tabs button {
      flex: 1;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .status-card {
      background: var(--panel);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .status-card h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .resource-links {
      margin-top: 0.75rem;
    }

    .resource-links a {
      display: inline-block;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: 1rem;
    }

    .theme-toggle button {
      margin: 0;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .upload-card {
      border: 1px dashed var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      background: var(--panel);
    }

    .upload-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>Admin <span class="build-number" id="build-number">build 251211</span>
    <span class="theme-toggle">
      <button id="theme-toggle" onclick="toggleTheme()">Toggle theme</button>
    </span>
  </h1>

  <div class="view-tabs">
    <button id="tab-editor" class="active" onclick="switchTab('editor')">Editor</button>
    <button id="tab-status" onclick="switchTab('status')">Status</button>
  </div>

  <div id="editor-view">
    <div class="note" id="default-password-note">
      Default admin password is <code>caddyLander</code>. Set the <code>ADMIN_PASSWORD</code> environment variable to change it.
    </div>

    <div class="panel">
      <h3>File Editor</h3>

      <div class="file-tabs">
        <button id="btn-content" onclick="switchFile('content.json')" class="active">content.json</button>
        <button id="btn-caddyfile" onclick="switchFile('Caddyfile')">Caddyfile</button>
      </div>

      <details id="schema-help" style="display: none;">
        <summary>Content Schema Help</summary>
        <div>
          <p><strong>Top-level fields (all optional):</strong></p>
          <ul>
            <li><code>siteTitle</code> (string) — Landing page heading</li>
            <li><code>siteSubtitle</code> (string) — Subheading/tagline</li>
            <li><code>theme</code> (string) — "light", "dark", or "auto" (system preference)</li>
            <li><code>favicon</code> (string) — Path under /static (e.g., "/static/favicon.ico")</li>
            <li><code>items</code> (array) — Array of link objects</li>
          </ul>
          <p><strong>Link object fields:</strong></p>
          <ul>
            <li><code>name</code> (string, required) — Display name</li>
            <li><code>url</code> (string, required) — Target URL</li>
            <li><code>desc</code> (string, optional) — Description text</li>
            <li><code>icon</code> (string, optional) — Emoji or symbol to display</li>
            <li><code>group</code> (string, optional) — Group header for categorization</li>
          </ul>
          <p><em>Note: Schema is backward-compatible. Old files without new fields work fine.</em></p>
        </div>
      </details>

      <div class="editor-container">
        <div id="editor"></div>
      </div>

      <div class="editor-actions">
        <button onclick="saveCurrentFile()">Save</button>
        <button onclick="downloadCurrentFile()">Download</button>
        <button onclick="generateFromCaddyfile()">Auto-build from Caddyfile</button>
      </div>

      <div id="content-status" class="status" style="display: none;"></div>
      <div id="caddyfile-status" class="status" style="display: none;"></div>
    </div>

    <div class="panel">
      <h3 id="backup-title">Content Backups</h3>
      <div>
        <label for="backup-select">Select version:</label><br>
        <select id="backup-select"></select>
      </div>
      <button onclick="loadBackupToEditor()">Load into editor</button>
      <button onclick="restoreBackup()">Restore</button>
      <div class="status">Last 10 backups are retained.</div>
    </div>

    <div class="panel">
      <h3>Favicon Management</h3>
      <p class="muted">Upload a replacement for <code>favicon.svg</code> or <code>favicon.ico</code>, or restore the bundled default assets.</p>
      <div class="upload-grid">
        <div class="upload-card">
          <strong>SVG</strong>
          <div class="upload-actions">
            <input type="file" id="upload-svg" accept=".svg,image/svg+xml">
            <button onclick="uploadFavicon('svg')">Upload</button>
            <button onclick="restoreFavicon('svg')">Restore default</button>
          </div>
        </div>
        <div class="upload-card">
          <strong>ICO</strong>
          <div class="upload-actions">
            <input type="file" id="upload-ico" accept=".ico,image/x-icon">
            <button onclick="uploadFavicon('ico')">Upload</button>
            <button onclick="restoreFavicon('ico')">Restore default</button>
          </div>
        </div>
      </div>
      <div id="favicon-status" class="status" style="display: none;"></div>
    </div>
  </div>

  <div id="status-view" style="display: none;">
    <div class="panel">
      <h3>Instance Status</h3>
      <div class="status-grid">
        <div class="status-card">
          <h4>Build</h4>
          <div id="status-build">Loading…</div>
          <div class="resource-links">
            <a href="https://github.com/mythosaz/caddyLander" target="_blank" rel="noopener">GitHub: mythosaz/caddyLander</a>
          </div>
        </div>
        <div class="status-card">
          <h4>Client</h4>
          <div class="muted">Source IP</div>
          <div id="status-client-ip">Loading…</div>
          <div class="muted">Forwarded Chain</div>
          <div id="status-client-chain">Loading…</div>
        </div>
        <div class="status-card">
          <h4>Server</h4>
          <div class="muted">Internal IPs</div>
          <div id="status-server-ip">Loading…</div>
        </div>
        <div class="status-card">
          <h4>Docker</h4>
          <div class="muted">Detected</div>
          <div id="status-docker">Loading…</div>
          <div class="muted">Container</div>
          <div id="status-container">Loading…</div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/editor.bundle.js"></script>
  <script>
    let currentFile = 'content.json';
    let currentTab = 'editor';
    const ADMIN_THEME_KEY = 'adminTheme';

    // Initialize editor
    document.addEventListener('DOMContentLoaded', () => {
      applyTheme(localStorage.getItem(ADMIN_THEME_KEY) || 'dark');
      CaddyEditor.init(document.getElementById('editor'));
      loadAdminInfo();
      switchFile('content.json');
    });

    function applyTheme(theme) {
      const normalized = theme === 'light' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', normalized);
      localStorage.setItem(ADMIN_THEME_KEY, normalized);

      const toggle = document.getElementById('theme-toggle');
      if (toggle) {
        toggle.textContent = normalized === 'light' ? 'Switch to dark' : 'Switch to light';
      }
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      applyTheme(next);
    }

    function switchFile(fileName) {
      currentFile = fileName;

      // Update button states
      document.getElementById('btn-content').classList.toggle('active', fileName === 'content.json');
      document.getElementById('btn-caddyfile').classList.toggle('active', fileName === 'Caddyfile');

      // Show/hide schema help
      document.getElementById('schema-help').style.display = fileName === 'content.json' ? 'block' : 'none';

      // Update backup title
      document.getElementById('backup-title').textContent = fileName === 'content.json' ? 'Content Backups' : 'Caddyfile Backups';

      // Hide both status messages
      document.getElementById('content-status').style.display = 'none';
      document.getElementById('caddyfile-status').style.display = 'none';

      // Load the file
      CaddyEditor.loadFile(fileName);

      // Refresh backups
      refreshBackups();
    }

    function saveCurrentFile() {
      CaddyEditor.saveFile();

      // Show appropriate status message
      if (currentFile === 'content.json') {
        document.getElementById('content-status').style.display = 'block';
        document.getElementById('caddyfile-status').style.display = 'none';
      } else {
        document.getElementById('content-status').style.display = 'none';
        document.getElementById('caddyfile-status').style.display = 'block';
      }
    }

    function downloadCurrentFile() {
      CaddyEditor.downloadFile();
    }

    function generateFromCaddyfile() {
      if (currentFile !== 'content.json') {
        switchFile('content.json');
      }

      fetch('/api/admin/content/generate')
        .then(r => {
          if (!r.ok) throw new Error('Failed');
          return r.json();
        })
        .then(data => {
          const content = JSON.stringify(data, null, 2);
          if (window.CaddyEditor && window.CaddyEditor.setContent) {
            window.CaddyEditor.setContent(content);
          }
          const status = document.getElementById('content-status');
          if (status) {
            status.textContent = 'Auto-built from Caddyfile. Review then save.';
            status.style.display = 'block';
          }
        })
        .catch(() => {
          const status = document.getElementById('content-status');
          if (status) {
            status.textContent = 'Unable to generate content from Caddyfile.';
            status.style.display = 'block';
          }
        });
    }

    function loadAdminInfo() {
      fetch("/api/admin/info")
        .then(r => r.json())
        .then(info => {
          if (!info.defaultPassword) {
            const note = document.getElementById("default-password-note");
            if (note) {
              note.style.display = "none";
            }
          }

          if (info.buildVersion) {
            const buildElement = document.getElementById("build-number");
            if (buildElement) {
              buildElement.textContent = `build ${info.buildVersion}`;
            }
            const statusBuild = document.getElementById("status-build");
            if (statusBuild) {
              statusBuild.textContent = info.buildVersion;
            }
          }

          if (info.status) {
            setStatusText("status-client-ip", info.status.clientIp || 'Unavailable');
            setStatusText("status-client-chain", info.status.clientChain || 'None');
            setStatusText("status-server-ip", (info.status.serverIps && info.status.serverIps.length)
              ? info.status.serverIps.join(', ')
              : 'Unavailable');

            if (info.status.docker) {
              setStatusText("status-docker", info.status.docker.detected ? 'Yes' : 'No');
              setStatusText("status-container", info.status.docker.containerId || 'n/a');
            }
          }
        });
    }

    function switchTab(tab) {
      currentTab = tab;
      const isEditor = tab === 'editor';
      document.getElementById('editor-view').style.display = isEditor ? 'block' : 'none';
      document.getElementById('status-view').style.display = isEditor ? 'none' : 'block';

      document.getElementById('tab-editor').classList.toggle('active', isEditor);
      document.getElementById('tab-status').classList.toggle('active', !isEditor);
    }

    function setStatusText(id, value) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value;
      }
    }

    function refreshBackups() {
      const select = document.getElementById("backup-select");
      select.innerHTML = "";

      const endpoint = currentFile === 'content.json'
        ? '/api/admin/content/backups'
        : '/api/admin/caddyfile/backups';

      fetch(endpoint)
        .then(r => r.json())
        .then(({ backups }) => {
          backups.forEach(entry => {
            const option = document.createElement("option");
            const date = new Date(entry.timestamp * 1000);
            option.value = entry.name;
            option.textContent = `${entry.name} (${date.toLocaleString()})`;
            select.appendChild(option);
          });
        });
    }

    // Make refreshBackups available globally for editor.js
    window.refreshBackups = refreshBackups;
    window.refreshCaddyfileBackups = refreshBackups;

    function loadBackupToEditor() {
      const select = document.getElementById("backup-select");
      const name = select.value;
      if (!name) return;

      const endpoint = currentFile === 'content.json'
        ? `/api/admin/content/backup?name=${encodeURIComponent(name)}`
        : `/api/admin/caddyfile/backup?name=${encodeURIComponent(name)}`;

      fetch(endpoint)
        .then(r => currentFile === 'content.json' ? r.json() : r.text())
        .then(data => {
          const content = currentFile === 'content.json'
            ? JSON.stringify(data, null, 2)
            : data;

          // Update editor content directly
          if (window.CaddyEditor && window.CaddyEditor.setContent) {
            window.CaddyEditor.setContent(content);
          } else {
            // Fallback: reload the file
            CaddyEditor.loadFile(currentFile);
          }
        });
    }

    function restoreBackup() {
      const select = document.getElementById("backup-select");
      const name = select.value;
      const statusId = currentFile === 'content.json' ? 'content-status' : 'caddyfile-status';
      const status = document.getElementById(statusId);

      if (!name) {
        status.textContent = "Select a backup first.";
        status.style.display = 'block';
        return;
      }

      const endpoint = currentFile === 'content.json'
        ? '/api/admin/content/restore'
        : '/api/admin/caddyfile/restore';

      status.textContent = "";
      status.style.display = 'none';

      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      })
        .then(r => {
          if (!r.ok) throw new Error("Failed");
          return r.json();
        })
        .then(_ => {
          const message = currentFile === 'content.json'
            ? "Backup restored and previous version saved."
            : "Backup restored and previous version saved. Reload Caddy to apply changes.";

          status.textContent = message;
          status.style.display = 'block';

          CaddyEditor.loadFile(currentFile);
          refreshBackups();
        })
        .catch(_ => {
          status.textContent = "Error restoring backup.";
          status.style.display = 'block';
        });
    }

    function setFaviconStatus(message) {
      const el = document.getElementById('favicon-status');
      if (el) {
        el.textContent = message;
        el.style.display = 'block';
      }
    }

    async function uploadFavicon(type) {
      const input = document.getElementById(`upload-${type}`);
      const statusTarget = document.getElementById('favicon-status');
      if (statusTarget) statusTarget.style.display = 'none';

      if (!input || !input.files || !input.files[0]) {
        setFaviconStatus('Select a file first.');
        return;
      }

      const file = input.files[0];
      if (type === 'svg' && !file.name.toLowerCase().endsWith('.svg')) {
        setFaviconStatus('Only .svg files are allowed for SVG uploads.');
        return;
      }
      if (type === 'ico' && !file.name.toLowerCase().endsWith('.ico')) {
        setFaviconStatus('Only .ico files are allowed for ICO uploads.');
        return;
      }

      try {
        const body = await file.arrayBuffer();
        const response = await fetch(`/api/admin/favicon?type=${encodeURIComponent(type)}`, {
          method: 'POST',
          body
        });

        if (!response.ok) {
          throw new Error('Upload failed');
        }

        setFaviconStatus(`Uploaded favicon.${type}.`);
        input.value = '';
      } catch (err) {
        console.error(err);
        setFaviconStatus('Upload failed. Confirm the file type and try again.');
      }
    }

    async function restoreFavicon(type) {
      const statusTarget = document.getElementById('favicon-status');
      if (statusTarget) statusTarget.style.display = 'none';
      try {
        const response = await fetch(`/api/admin/favicon/restore?type=${encodeURIComponent(type)}`, { method: 'POST' });
        if (!response.ok) throw new Error('Restore failed');
        setFaviconStatus(`Restored default favicon.${type}.`);
      } catch (err) {
        console.error(err);
        setFaviconStatus('Restore failed.');
      }
    }
  </script>
</body>
</html>
