<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin</title>
  <style>
    body {
      font-family: system-ui;
      background: #222;
      color: #eee;
      padding: 2rem;
      margin: 0;
    }

    button {
      padding: 0.5rem 1.2rem;
      margin: 0.25rem;
      background: #444;
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #555;
    }

    button.active {
      background: #0066cc;
      border-color: #0066cc;
    }

    select {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: #333;
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
    }

    .panel {
      margin-bottom: 2rem;
    }

    .status {
      margin-top: 0.5rem;
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 4px;
      background: #333;
    }

    .note {
      background: #333;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .file-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .file-tabs button {
      flex: 1;
    }

    .editor-container {
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 1rem;
      background: #282c34;
    }

    .editor-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .cm-editor {
      height: 500px;
      font-size: 14px;
    }

    details {
      margin: 1rem 0;
      padding: 0.75rem;
      background: #333;
      border-radius: 6px;
    }

    summary {
      cursor: pointer;
      font-weight: bold;
    }

    details div {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    code {
      background: #444;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
    }

    .build-number {
      color: #888;
      font-size: 0.7rem;
      margin-left: 0.5rem;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <h1>Admin <span class="build-number">build 2025.01</span></h1>

  <div class="note" id="default-password-note">
    Default admin password is <code>caddyLander</code>. Set the <code>ADMIN_PASSWORD</code> environment variable to change it.
  </div>

  <div class="panel">
    <h3>File Editor</h3>

    <div class="file-tabs">
      <button id="btn-content" onclick="switchFile('content.json')" class="active">content.json</button>
      <button id="btn-caddyfile" onclick="switchFile('Caddyfile')">Caddyfile</button>
    </div>

    <details id="schema-help" style="display: none;">
      <summary>Content Schema Help</summary>
      <div>
        <p><strong>Top-level fields (all optional):</strong></p>
        <ul>
          <li><code>siteTitle</code> (string) — Landing page heading</li>
          <li><code>siteSubtitle</code> (string) — Subheading/tagline</li>
          <li><code>theme</code> (string) — "light", "dark", or "auto" (system preference)</li>
          <li><code>favicon</code> (string) — Path under /static (e.g., "/static/favicon.ico")</li>
          <li><code>items</code> (array) — Array of link objects</li>
        </ul>
        <p><strong>Link object fields:</strong></p>
        <ul>
          <li><code>name</code> (string, required) — Display name</li>
          <li><code>url</code> (string, required) — Target URL</li>
          <li><code>desc</code> (string, optional) — Description text</li>
          <li><code>icon</code> (string, optional) — Emoji or symbol to display</li>
          <li><code>group</code> (string, optional) — Group header for categorization</li>
        </ul>
        <p><em>Note: Schema is backward-compatible. Old files without new fields work fine.</em></p>
      </div>
    </details>

    <div class="editor-container">
      <div id="editor"></div>
    </div>

    <div class="editor-actions">
      <button onclick="saveCurrentFile()">Save</button>
      <button onclick="downloadCurrentFile()">Download</button>
    </div>

    <div id="content-status" class="status" style="display: none;"></div>
    <div id="caddyfile-status" class="status" style="display: none;"></div>
  </div>

  <div class="panel">
    <h3 id="backup-title">Content Backups</h3>
    <div>
      <label for="backup-select">Select version:</label><br>
      <select id="backup-select"></select>
    </div>
    <button onclick="loadBackupToEditor()">Load into editor</button>
    <button onclick="restoreBackup()">Restore</button>
    <div class="status">Last 10 backups are retained.</div>
  </div>

  <script src="/static/editor.bundle.js"></script>
  <script>
    let currentFile = 'content.json';

    // Initialize editor
    document.addEventListener('DOMContentLoaded', () => {
      CaddyEditor.init(document.getElementById('editor'));
      loadAdminInfo();
      switchFile('content.json');
    });

    function switchFile(fileName) {
      currentFile = fileName;

      // Update button states
      document.getElementById('btn-content').classList.toggle('active', fileName === 'content.json');
      document.getElementById('btn-caddyfile').classList.toggle('active', fileName === 'Caddyfile');

      // Show/hide schema help
      document.getElementById('schema-help').style.display = fileName === 'content.json' ? 'block' : 'none';

      // Update backup title
      document.getElementById('backup-title').textContent = fileName === 'content.json' ? 'Content Backups' : 'Caddyfile Backups';

      // Hide both status messages
      document.getElementById('content-status').style.display = 'none';
      document.getElementById('caddyfile-status').style.display = 'none';

      // Load the file
      CaddyEditor.loadFile(fileName);

      // Refresh backups
      refreshBackups();
    }

    function saveCurrentFile() {
      CaddyEditor.saveFile();

      // Show appropriate status message
      if (currentFile === 'content.json') {
        document.getElementById('content-status').style.display = 'block';
        document.getElementById('caddyfile-status').style.display = 'none';
      } else {
        document.getElementById('content-status').style.display = 'none';
        document.getElementById('caddyfile-status').style.display = 'block';
      }
    }

    function downloadCurrentFile() {
      CaddyEditor.downloadFile();
    }

    function loadAdminInfo() {
      fetch("/api/admin/info")
        .then(r => r.json())
        .then(info => {
          if (!info.defaultPassword) {
            const note = document.getElementById("default-password-note");
            if (note) {
              note.style.display = "none";
            }
          }
        });
    }

    function refreshBackups() {
      const select = document.getElementById("backup-select");
      select.innerHTML = "";

      const endpoint = currentFile === 'content.json'
        ? '/api/admin/content/backups'
        : '/api/admin/caddyfile/backups';

      fetch(endpoint)
        .then(r => r.json())
        .then(({ backups }) => {
          backups.forEach(entry => {
            const option = document.createElement("option");
            const date = new Date(entry.timestamp * 1000);
            option.value = entry.name;
            option.textContent = `${entry.name} (${date.toLocaleString()})`;
            select.appendChild(option);
          });
        });
    }

    // Make refreshBackups available globally for editor.js
    window.refreshBackups = refreshBackups;
    window.refreshCaddyfileBackups = refreshBackups;

    function loadBackupToEditor() {
      const select = document.getElementById("backup-select");
      const name = select.value;
      if (!name) return;

      const endpoint = currentFile === 'content.json'
        ? `/api/admin/content/backup?name=${encodeURIComponent(name)}`
        : `/api/admin/caddyfile/backup?name=${encodeURIComponent(name)}`;

      fetch(endpoint)
        .then(r => currentFile === 'content.json' ? r.json() : r.text())
        .then(data => {
          const content = currentFile === 'content.json'
            ? JSON.stringify(data, null, 2)
            : data;

          // Update editor content directly
          if (window.CaddyEditor && window.CaddyEditor.setContent) {
            window.CaddyEditor.setContent(content);
          } else {
            // Fallback: reload the file
            CaddyEditor.loadFile(currentFile);
          }
        });
    }

    function restoreBackup() {
      const select = document.getElementById("backup-select");
      const name = select.value;
      const statusId = currentFile === 'content.json' ? 'content-status' : 'caddyfile-status';
      const status = document.getElementById(statusId);

      if (!name) {
        status.textContent = "Select a backup first.";
        status.style.display = 'block';
        return;
      }

      const endpoint = currentFile === 'content.json'
        ? '/api/admin/content/restore'
        : '/api/admin/caddyfile/restore';

      status.textContent = "";
      status.style.display = 'none';

      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      })
        .then(r => {
          if (!r.ok) throw new Error("Failed");
          return r.json();
        })
        .then(_ => {
          const message = currentFile === 'content.json'
            ? "Backup restored and previous version saved."
            : "Backup restored and previous version saved. Restart Caddy Required.";

          status.textContent = message;
          status.style.display = 'block';

          CaddyEditor.loadFile(currentFile);
          refreshBackups();
        })
        .catch(_ => {
          status.textContent = "Error restoring backup.";
          status.style.display = 'block';
        });
    }
  </script>
</body>
</html>
