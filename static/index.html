<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Landing</title>
  <style>
    :root {
      --bg-color: #111;
      --text-color: #eee;
      --link-color: #7aa2f7;
      --group-color: #999;
      --border-color: #333;
    }

    [data-theme="light"] {
      --bg-color: #f5f5f5;
      --text-color: #222;
      --link-color: #2563eb;
      --group-color: #666;
      --border-color: #ddd;
    }

    body {
      font-family: system-ui;
      background: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      transition: background-color 0.3s, color 0.3s;
    }

    #controls {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    #controls .theme-options {
      display: flex;
      gap: 0.25rem;
    }

    .theme-options button {
      padding: 0.35rem 0.6rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-color);
      cursor: pointer;
    }

    .theme-options button.active {
      background: var(--border-color);
      border-color: var(--link-color);
    }

    .item {
      margin-bottom: 1rem;
    }

    a {
      color: var(--link-color);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #admin {
      font-size: 24px;
    }

    .subtitle {
      color: var(--group-color);
      font-size: 1.2rem;
      margin-top: -0.5rem;
      margin-bottom: 2rem;
    }

    .group-header {
      font-size: 1.3rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border-color);
      color: var(--group-color);
    }

    .group-header:first-child {
      margin-top: 0;
    }

    .icon {
      display: inline-block;
      width: 1.5em;
      text-align: center;
      margin-right: 0.3em;
    }
  </style>
</head>
<body>
  <div id="controls">
    <a id="admin" href="/admin">ðŸ”’</a>
    <div class="theme-options">
      <button id="theme-auto" onclick="setTheme('auto')">Auto</button>
      <button id="theme-light" onclick="setTheme('light')">Light</button>
      <button id="theme-dark" onclick="setTheme('dark')">Dark</button>
    </div>
  </div>

  <h1 id="site-title">Services</h1>
  <div id="site-subtitle" class="subtitle"></div>
  <div id="content"></div>

  <script>
    const THEME_KEY = 'caddyLanderTheme';
    const LEGACY_KEYS = ['landingTheme', 'adminTheme'];
    const mediaQuery = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)');

    if (mediaQuery && mediaQuery.addEventListener) {
      mediaQuery.addEventListener('change', () => {
        if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') {
          applyThemePreference('auto');
        }
      });
    }

    function applyThemePreference(preference) {
      const stored = preference || localStorage.getItem(THEME_KEY) || resolveInitialTheme();
      const resolved = stored === 'auto'
        ? (mediaQuery && mediaQuery.matches ? 'light' : 'dark')
        : stored;

      document.documentElement.setAttribute('data-theme', resolved === 'light' ? 'light' : 'dark');
      localStorage.setItem(THEME_KEY, stored);
      updateThemeButtons(stored);
    }

    function resolveInitialTheme() {
      const existing = localStorage.getItem(THEME_KEY);
      if (existing) return existing;

      for (const legacy of LEGACY_KEYS) {
        const legacyValue = localStorage.getItem(legacy);
        if (legacyValue) {
          localStorage.setItem(THEME_KEY, legacyValue);
          return legacyValue;
        }
      }

      localStorage.setItem(THEME_KEY, 'auto');
      return 'auto';
    }

    function setTheme(value) {
      applyThemePreference(value);
    }

    function updateThemeButtons(active) {
      ['auto', 'light', 'dark'].forEach(option => {
        const btn = document.getElementById(`theme-${option}`);
        if (btn) {
          btn.classList.toggle('active', active === option);
        }
      });
    }

    applyThemePreference(resolveInitialTheme());

    fetch("/api/content")
      .then(r => r.json())
      .then(data => {
        const preferredTheme = localStorage.getItem(THEME_KEY) || data.theme || 'auto';
        applyThemePreference(preferredTheme);

        // Apply site title
        if (data.siteTitle) {
          document.getElementById("site-title").textContent = data.siteTitle;
          document.title = data.siteTitle;
        }

        // Apply site subtitle
        if (data.siteSubtitle) {
          document.getElementById("site-subtitle").textContent = data.siteSubtitle;
        }

        // Apply favicon
        if (data.favicon) {
          let link = document.querySelector("link[rel~='icon']");
          if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            document.getElementsByTagName('head')[0].appendChild(link);
          }
          link.href = data.favicon;
        }

        // Render items
        const content = document.getElementById("content");
        const items = data.items || [];

        // Group items
        const grouped = {};
        const ungrouped = [];

        items.forEach(item => {
          if (item.group) {
            if (!grouped[item.group]) {
              grouped[item.group] = [];
            }
            grouped[item.group].push(item);
          } else {
            ungrouped.push(item);
          }
        });

        // Render ungrouped items first
        ungrouped.forEach(item => {
          content.appendChild(createItemElement(item));
        });

        // Render grouped items
        Object.keys(grouped).sort().forEach(groupName => {
          const header = document.createElement("div");
          header.className = "group-header";
          header.textContent = groupName;
          content.appendChild(header);

          grouped[groupName].forEach(item => {
            content.appendChild(createItemElement(item));
          });
        });

        function createItemElement(item) {
          const div = document.createElement("div");
          div.className = "item";

          const icon = item.icon ? `<span class="icon">${item.icon}</span>` : '';
          const name = item.name || item.title || 'Unnamed';
          const desc = item.desc ? ` â€” ${item.desc}` : '';

          div.innerHTML = `${icon}<a href="${item.url}">${name}</a>${desc}`;
          return div;
        }
      });
  </script>
</body>
</html>
